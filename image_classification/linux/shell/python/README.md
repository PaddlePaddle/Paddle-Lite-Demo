# 图像分类 Python API Demo 使用指南

在 Linux 上实现实图像分类功能，此 Demo 有很好的的易用性和开放性，如在 Demo 中跑自己训练好的模型等.
本文主要介绍图像分类 Demo 运行方法和如何在更新模型/输入/输出处理下，保证图像分类 demo 仍可继续运行。

## 如何运行图像分类 Demo

### 环境准备

1. 安装 Opencv 包
使用 pip 工具安装 opencv 包

```shell
# 当前最新版本是 2.10rc0
python -m pip install opencv-python
```

### 部署步骤

1. 图像分类 Demo 位于 `Paddle-Lite-Demo/image_classification/linux/shell/python` 目录
2. cd `Paddle-Lite-Demo/image_classification/assets` 目录，运行 `download.sh` 脚本，下载 OPT 优化后模型、测试图片和标签文件
3. 安装 Paddle Lite 预测包
4. cd `Paddle-Lite-Demo/image_classification/linux/shell/python` 目录, 运行 `run.sh` 脚本，进行图像分类预测

```shell
cd Paddle-Lite-Demo/image_classification/assets
# 下载OPT 优化后模型、测试图片、标签文件
sh download.sh
# 当前最新版本是 2.10rc0
python -m pip install paddlelite==2.10rc0
cd ../linux/shell/python
sh run.sh
```

5. 运行结果如下：

```shell
================== Speed Report ===================
model: ./mv1.nb, run avg_time:  1.7610676288604733e-05 ms, min_time:  1.4084100723266602e-05 ms
================== Precision Report ===================
i: 0, index: 285, name: n02124075 Egyptian cat
, score: 0.4729956388473511
i: 1, index: 281, name: n02123045 tabby, tabby cat
, score: 0.43637195229530334
i: 2, index: 282, name: n02123159 tiger cat
, score: 0.07664451748132706
================== Report End ===================
```

## 更新预测库

* Paddle Lite 项目：https://github.com/PaddlePaddle/Paddle-Lite
 * 参考 [Paddle Lite 源码编译文档](https://paddle-lite.readthedocs.io/zh/latest/source_compile/compile_env.html)准环境
 * 参考[源码编译 (ARMLinux)](https://paddle-lite.readthedocs.io/zh/develop/source_compile/linux_x86_compile_arm_linux.html)编译和安装 Paddle Lite 的 python 包。

## Demo 内容介绍

整个demo 由 image_classifiction.py 一个 python 脚本组成，它包含以下几个功能函数：

* `Init` 初始化函数
功能：完成模型初始化和推理引擎创建
* `PreProcss` 预处理函数
功能：完成模型输入的预处理操作
* `PostProcss` 后处理函数
功能：完成模型输出的预处理操作
* `RunModel` 预测函数
功能：完成模型预测全流程的控制和调度
* `parse_shape` 和 `load_labels` 辅助功能函数
功能：完成参数解析、文件加载等辅助功能


## 代码讲解 （使用 Paddle Lite `Python API` 执行预测）

该示例基于 Python API 开发，调用 Paddle Lite `Python API` 包括以下五步。更详细的 `API` 描述参考：[Paddle Lite Python API ](https://paddle-lite.readthedocs.io/zh/develop/api_reference/python_api_doc.html)。

```py
# 1 引入必要的库
from paddlelite.lite import *
import numpy as np

# 2 指定模型文件，创建 predictor
## 1. Set config information
config = MobileConfig()
## 2. Set the path to the model generated by opt tools
config.set_model_from_file(args.model_dir)
## 3. Set thread num
config.set_threads(1)
## 4. Create predictor by config
predictor = create_paddle_predictor(config)

# 3 设置模型输入 (下面以全一输入为例)
input_tensor = predictor.get_input(0)
input_tensor.from_numpy(np.ones((1, 3, 224, 224)).astype("float32"))

# 如果模型有多个输入，每一个模型输入都需要准确设置 shape 和 data。

# 4 执行预测
predictor.run()

# 5 获得预测结果并将预测结果转化为 numpy 数组
output_tensor = predictor.get_output(0)
output_data = output_tensor.numpy()
print(output_data)
```

## 如何更新模型和输入/输出预处理

### 更新模型
1. 将优化后的模型存放到目录 `image_classification/assets/models/` 下；
2. 如果模型名字跟工程中模型名字一模一样，即均是使用 `mobilenet_v1_for_cpu/model.nb`，则代码不需更新；否则话，需要修改 `image_classification/liunx/shell/python/run.sh` 脚本。

以更新 mobilenet_v2 模型为例，则先将优化后的模型存放到 `image_classification/assets/models/mobilenet_v2_for_cpu/model.nb` 下，然后更新脚本。

```py
# old
python ./image_classification.py --model_dir ../../../assets/models/mobilenet_v1_for_cpu/model.nb \
--input_shape=1,3,224,224 --image_path ../../../assets/images/tabby_cat.jpg \
--label_path ../../../assets/labels/labels.txt \
--topk=3 --repeats=100 --warmup=10

# now
python ./image_classification.py --model_dir ../../../assets/models/mobilenet_v2_for_cpu/model.nb \
--input_shape=1,3,224,224 --image_path ../../../assets/images/tabby_cat.jpg \
--label_path ../../../assets/labels/labels.txt \
--topk=3 --repeats=100 --warmup=10
```

**注意：**

- 如果更新模型的输入/输出 Tensor 个数、shape 和 Dtype 发生更新，需要更新文件 `image_classification/liunx/shell/python/image_classifiction.py` 代码中的 `PreProcess` 操作

- 如果需要更新 `labels.txt` 标签文件，则需要将新的标签文件存放在目录 `image_classification/assets/lables`，并更新`image_classification/liunx/shell/python/run.sh` 脚本。

```py
# old
python ./image_classification.py --model_dir ../../../assets/models/mobilenet_v1_for_cpu/model.nb \
--input_shape=1,3,224,224 --image_path ../../../assets/images/tabby_cat.jpg \
--label_path ../../../assets/labels/labels.txt \
--topk=3 --repeats=100 --warmup=10

# now
python ./image_classification.py --model_dir ../../../assets/models/mobilenet_v2_for_cpu/model.nb \
--input_shape=1,3,224,224 --image_path ../../../assets/images/tabby_cat.jpg \
--label_path ../../../assets/labels/labels_new.txt \
--topk=3 --repeats=100 --warmup=10
```


### 更新输入/输出预处理
1. 更新输入数据

- 将更新的图片存放在 `image_classification/assets/images/` 下；
- 更新`image_classification/liunx/shell/python/run.sh` 脚本

以更新 `dog.jpg` 为例，则先将 `dog.jpg` 存放在 `image_classification/assets/images/` 下，然后更新代码

```py
# old
python ./image_classification.py --model_dir ../../../assets/models/mobilenet_v1_for_cpu/model.nb \
--input_shape=1,3,224,224 --image_path ../../../assets/images/tabby_cat.jpg \
--label_path ../../../assets/labels/labels.txt \
--topk=3 --repeats=100 --warmup=10

# now
python ./image_classification.py --model_dir ../../../assets/models/mobilenet_v2_for_cpu/model.nb \
--input_shape=1,3,224,224 --image_path ../../../assets/images/dog.jpg \
--label_path ../../../assets/labels/labels_new.txt \
--topk=3 --repeats=100 --warmup=10
```

2. 更新输入预处理
此处需要更新 更新文件 `image_classification/liunx/shell/python/image_classifiction.py` 代码中的 `PreProcess` 操作

3. 更新输出预处理
更新文件 `image_classification/liunx/shell/python/image_classifiction.py` 代码中的 `PostProcess` 操作
